SLES Project - Quick Reference
===============================

## Migration Strategy
Porting SLES from .dropbox/ to clean Git structure. Focus: estimation only.
Future work: Port other states from old monolithic scripts to state_procedures/XX.R pattern.

## Estimation Process Overview

1. Load bill details, bill history, SS bills, commemorative bills, and legiscan
   legislator data for the given state/term.

2. Clean and standardize: normalize bill IDs, parse dates, filter to valid bill
   types, remove committee-sponsored bills.

3. Join importance flags (SS, commemorative) to bill details on bill_id. Dedupe
   SS bills that appear in multiple years with identical titles.

4. Compute achievement vector for each bill by evaluating its history against
   state-specific step terms.

5. Reconcile bill sponsors with legiscan legislator records via fuzzy matching.
   Derive sponsor stats (pass rate, law rate) and cosponsorship counts (if available).

6. Calculate LES for each legislator: weight bills by type and achievement stage, normalize within chamber.

7. Write legislator scores and coded bills to CSV outputs.

## Data Structure (.data/STATE/)
- bill/          Bill details & histories
- commem/        Commemorative bills
- legiscan/      Legislator metadata by session
- ss/            Substantive & Significant bills
- outputs/       Generated LES scores

## Architecture
CLI → Operation Modules (estimate, commem, compile)
- Modules are standalone (dual CLI/Rscript usage)
- CLI orchestrates multi-op workflows
- Shared code in utils/ (paths, logging, libs, strings, +more as needed)

## Code Style (lintr)
- Implicit returns (no `return()`)
- Max 80 char lines
- snake_case naming
- Space before `(` in control flow (if, while, for), not function calls
- Prefer `for (i in seq_len(nrow(df)))` over `for (i in 1:nrow(df))`

## Implementation Status

### Complete
- cli.R - Working, estimate operation only
- estimate/estimate.R - Full orchestrator (stages 1-7)
- utils/ - paths, logging, libs, strings
- estimate/states/WI.R - All hooks (Stage 1.5, 2, 5, 6)
- estimate/states/AR.R - All hooks (Stage 1.5, 2, 5, 6)
- estimate/states/loader.R - Dynamic state config loader
- estimate/lib/bill_history.R - evaluate_bill_history utility
- estimate/lib/les_calc.R - LES calculation with 39-column output
- estimate/pipeline/* - All 7 stages working

### Pipeline Status
WI 2023_2024: 133 legislators, 0.9985 correlation with original (5 SS bill diff)
AR 2023_2024: 136 legislators (101 House, 35 Senate)

Output format: 39 columns including detailed breakdowns (all/ss/s/c bills × 5 stages)
Weights: SS=10, regular=5, commemorative=1

## Estimation Architecture

### Structure

estimate/
├── estimate.R                  # Thin orchestrator
├── pipeline/                   # Modular pipeline stages
│   ├── load_data.R             # Stage 1: Load & validate data files
│   ├── clean_data.R            # Stage 2: Clean bill details, bill history, SS
│   ├── join_data.R             # Stage 3: Join SS, commem to bill details
│   ├── compute_achievement.R   # Stage 4: Leg achievement matrix from bill history
│   ├── reconcile_legislators.R # Stage 5: Match sponsors to legiscan
│   ├── validate_legislators.R  # Stage 5.5: Zero-LES (no sponsored bills) check + review 
│   ├── calculate_scores.R      # Stage 6: Compute LES scores
│   └── write_outputs.R         # Stage 7: Write CSV outputs
├── states/                     # State-specific configs & overrides
│   ├── WI.R                    # Config + hooks
│   └── loader.R                # Dynamic state loader
└── lib/                        # Estimation-specific utilities
    ├── assertions.R            # All assert_* functions
    ├── bill_history.R          # evaluate_bill_history logic
    └── les_calc.R              # LES calculation

### Design Principles
- estimate.R: Thin orchestrator, calls pipeline stages sequentially
- Pipeline stages: Focused modules (~100-150 lines), clear input/output
- State files: Minimal - config + state-specific hooks only
- Generic logic in pipeline, state quirks in state files

### State-Specific Hooks
Stage 1.5: preprocess_raw_data, get_bill_file_suffix
Stage 2: clean_bill_details, clean_bill_history
Stage 5: derive_unique_sponsors, compute_cosponsorship, clean_sponsor_names,
         adjust_legiscan_data, reconcile_legiscan_with_sponsors
Stage 6: prepare_bills_for_les (chamber derivation)

## Implementation Guidelines

### Porting States from Legacy Scripts
CRITICAL: When implementing a new state, thoroughly review the original script
to ensure ALL logic is captured:

1. **Data Loading**: Check for custom file naming, column names, data formats
2. **Filtering Logic**: Verify committee bill filtering, bill type filtering,
   empty sponsor handling
3. **Name Standardization**: Capture lowercasing, accent removal, name fixes
4. **Session Handling**: Check for session recoding, year extraction
5. **Bill ID Formatting**: Verify zero-padding, special session handling
6. **State-Specific Corrections**: Look for term-specific fixes, edge cases

Common missed items:
- Committee-sponsored bill filtering (must lowercase sponsors first!)
- Empty/missing sponsor filtering
- Name standardization (tolower, accent removal)
- Session variable recoding
- Bill ID zero-padding and special session handling

The goal: Implement the SAME logic as the original, just organized into the
modular hook pattern. Don't skip steps or assume "it probably doesn't matter."

### Strict Porting vs Editorial Discretion
When porting code from the original codebase:
- Only add logic that exists in the original. Do not invent fixes.
- If something seems broken or missing, flag it rather than solving it.
- If debugging reveals a mismatch, check whether the original handles it first.
- Term-specific fixes (names, bill IDs) must come from the original scripts.

## Known Issues

### SS Bill Duplication
Some bills appear in PVS data for multiple years within a term with identical
titles (e.g., WI 2023-2024: AB0377, AB0415, SB0139, SB0145, SB0312). Solution: keep
earliest year for identical titles. See .dropbox/ss_duplicate_investigation.ipynb.

---
Updated: 2026-01-01
