SLES Project - Quick Reference
===============================

## Migration Strategy
Porting SLES from .dropbox/ to clean Git structure. Focus: estimation only.
Future work: Port other states from old monolithic scripts to state_procedures/XX.R pattern.

## Data Structure (.data/STATE/)
- bill/          Bill details & histories
- commem/        Commemorative bills
- legiscan/      Legislator metadata by session
- ss/            Substantive & Significant bills
- outputs/       Generated LES scores

## Architecture
CLI → Operation Modules (estimate, commem, compile)
- Modules are standalone (dual CLI/Rscript usage)
- CLI orchestrates multi-op workflows
- Shared code in utils/ (paths, logging, libs, strings, +more as needed)

## Code Style (lintr)
- Implicit returns (no `return()`)
- Max 80 char lines
- snake_case naming
- Space before `(` in control flow (if, while, for), not function calls

## Implementation Status

### Complete
- cli.R - Working, estimate operation only
- estimate/estimate.R - Full orchestrator (stages 1-7)
- utils/ - paths, logging, libs, strings
- estimate/states/WI.R - All state-specific hooks:
  - Stage 2: clean_bill_details, clean_bill_history
  - Stage 5: derive_unique_sponsors, compute_cosponsorship,
    clean_sponsor_names, adjust_legiscan_data,
    reconcile_legiscan_with_sponsors
- estimate/states/loader.R - Dynamic state config loader
- estimate/lib/bill_history.R - evaluate_bill_history utility
- estimate/lib/les_calc.R - LES calculation engine
- estimate/pipeline/load_data.R - Stage 1 (loads all CSVs)
- estimate/pipeline/clean_data.R - Stage 2 (generic + WI-specific cleaning)
- estimate/pipeline/join_data.R - Stage 3 (join SS/commem flags)
- estimate/pipeline/compute_achievement.R - Stage 4 (achievement matrix)
- estimate/pipeline/reconcile_legislators.R - Stage 5 (sponsor/legiscan match)
- estimate/pipeline/validate_legislators.R - Stage 5.5 (zero-LES review)
- estimate/pipeline/calculate_scores.R - Stage 6 (weighted + unweighted LES)
- estimate/pipeline/write_outputs.R - Stage 7 (CSV output)

### Full Pipeline Working
All stages complete and tested with WI 2023_2024. Produces LES scores for
133 legislators with correct weights (SS=10, reg=5, com=1), both weighted and
unweighted scores, and full output format matching original implementation.

WI state fully ported with all Stage 2 and Stage 5 hooks implemented.

Stage 5.5 handles zero-LES legislators with interactive review workflow:
- Detects legislators with zero sponsored bills
- Prompts for manual review (served full term vs. early exit)
- Caches decisions in .data/STATE/review/ CSV
- Removes flagged legislators before LES calculation

## Estimation Architecture

### Structure

estimate/
├── estimate.R           # Thin orchestrator, calls pipeline stages
├── pipeline/            # Modular pipeline stages
│   ├── load_data.R      # Stage 1: Load & validate data files
│   ├── clean_data.R     # Stage 2: Clean bills, SS, history
│   ├── join_data.R      # Stage 3: Join SS, commem to bills
│   ├── compute_achievement.R  # Stage 4: Bill achievement matrix
│   ├── reconcile_legislators.R  # Stage 5: Match sponsors to legiscan
│   ├── validate_legislators.R   # Stage 5.5: Zero-LES review
│   ├── calculate_scores.R  # Stage 6: Compute LES scores (weighted + unweighted)
│   └── write_outputs.R  # Stage 7: Write CSV outputs
├── states/              # State-specific configs & overrides
│   ├── WI.R            # Config + Stage 2 & 5 hooks
│   └── loader.R        # Dynamic state loader (no manual dispatch)
└── lib/                # Estimation-specific utilities
    ├── assertions.R    # All assert_* functions
    ├── bill_history.R  # evaluate_bill_history logic
    └── les_calc.R      # LES calculation (from calculate_LES.R)

### Design Principles
- estimate.R: Thin orchestrator, calls pipeline stages sequentially
- Pipeline stages: Focused modules (~100-150 lines), clear input/output
- State files: Minimal - config + state-specific function hooks only
- Generic logic in pipeline, state quirks in state files

### State-Specific Hooks
Stage 2 (clean_data):
- clean_bill_details(bill_details, term) - Bill detail transformations
- clean_bill_history(bill_history, term) - History cleaning

Stage 5 (reconcile_legislators):
- derive_unique_sponsors(bills, term) - Extract unique sponsors from bills
- compute_cosponsorship(all_sponsors, bills) - Count cosponsored bills
- clean_sponsor_names(all_sponsors, term) - Name standardization/fixes
- adjust_legiscan_data(legiscan, term) - Legiscan record adjustments
- reconcile_legiscan_with_sponsors(sponsors, legiscan, term) - Fuzzy
  matching

## Known Issues

### SS Bill Duplication (WI 2023_2024)
Some bills appear in PVS data for multiple years within a term with identical
titles, creating duplicates when joining. Solution: keep earliest year for
identical titles. Affected bills: AB0377, AB0415, SB0139, SB0145, SB0312.
See .dropbox/ss_duplicate_investigation.ipynb for full analysis.

## Next Steps
1. Test with other WI terms:
   - 2021_2022 (has custom legiscan adjustments and matching rules)
   - 2019_2020 (has custom matching rules)
   - Earlier terms (various name corrections)
2. Expand to other states (AR, etc.)
   - Copy WI.R as template
   - Implement state-specific hooks as needed

---
Updated: 2026-01-01
